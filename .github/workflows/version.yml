name: Release graph-aws
on:
  release:
    types:
      - published

jobs:
  integration-deployments:
    name: Release integration-deployments
    runs-on: ubuntu-latest
    outputs:
      pull-request-url:
        ${{ steps.create-pull-request.outputs.pull-request-url }}
    steps:
      - name: Get version number
        id: get-version-number
        uses: actions/github-script@0.9.0
        with:
          script: |
            const tagName = context.payload.release.tag_name
            const versionNumber = tagName.replace("v", "")
            core.setOutput('versionNumber', versionNumber)
      - name: Setup Node
        uses: actions/setup-node@v1
        with:
          node-version: 14.x
      - name: Clone integration-deployments repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.AUTO_GITHUB_PAT_TOKEN }}
          repository: JupiterOne/integration-deployments
          ref: main
          path: './integration-deployments'
      - name: Set git config
        shell: bash
        working-directory: ./integration-deployments
        run: |
          git config --local user.email "internal-automation.bot@jupiterone.com"
          git config --local user.name "j1-internal-automation"
      - name: Clean up and create branch
        shell: bash
        working-directory: ./integration-deployments
        run: |
          git reset --hard
          git checkout -b deploy-graph-jira-${{ steps.get-version-number.outputs.versionNumber }}
          git push origin deploy-graph-jira-${{ steps.get-version-number.outputs.versionNumber }}
      - name: Bump version in package.json and commit changes
        shell: bash
        working-directory: ./integration-deployments
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_AUTH_TOKEN }}" > .npmrc
          cd ./src/jira
          yarn
          yarn upgrade @jupiterone/graph-jira@^${{ steps.get-version-number.outputs.versionNumber }}
          git add .
          git commit -m "bump graph-jira to version ${{ steps.get-version-number.outputs.versionNumber }} deploy2dev"
      - name: Create Pull Request
        id: create-pull-request
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.AUTO_GITHUB_PAT_TOKEN }}
          path: ./integration-deployments
          branch:
            deploy-graph-jira-${{ steps.get-version-number.outputs.versionNumber
            }}
          base: main
          title:
            '[Github Action] - Deploy graph-jira v${{
            steps.get-version-number.outputs.versionNumber }}'
          body: |
            ## Summary
            ${{ github.event.release.body }}
      - name: Enable Automerge
        if:
          steps.create-pull-request.outputs.pull-request-operation == 'created'
        run:
          gh pr merge --squash --auto "${{
          steps.create-pull-request.outputs.pull-request-url }}"
        env:
          GH_TOKEN: ${{ secrets.AUTO_GITHUB_PAT_TOKEN }}

  slack-webhook:
    name: Send Slack webhook
    runs-on: ubuntu-latest
    needs: [integration-deployments]
    steps:
      - name: Get version number
        id: get-version-number
        uses: actions/github-script@0.9.0
        with:
          script: |
            const tagName = context.payload.release.tag_name
            const versionNumber = tagName.replace("v", "")
            core.setOutput('versionNumber', versionNumber)
      - name: Notify Slack
        env:
          INTEGRATION_DEPLOYMENTS:
            ${{ needs.integration-deployments.outputs.pull-request-url }}
        shell: bash
        run: |
          curl --request POST \
            --url ${{ secrets.SLACK_WEBHOOK }} \
            --header 'Content-Type: application/json' \
            --data '{
              "body": "PR for integration-deployments: ${{ env.INTEGRATION_DEPLOYMENTS }} ",
              "title": "Release graph-jira v${{ steps.get-version-number.outputs.versionNumber }}"
            }'
